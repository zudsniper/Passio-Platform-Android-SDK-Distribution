# Passio Platform Android SDK

[![release](https://img.shields.io/badge/release-v2.2.12-brightgreen)](https://search.maven.org/artifact/ai.passio.passiosdk/platformsdk/2.2.12/aar)    [![release](https://img.shields.io/badge/platform-Android-lightgray)]() [![release](https://img.shields.io/badge/minimum--supported--version-26-lightgray)](https://developer.android.com/about/versions/oreo)  [![release](https://img.shields.io/badge/Kotlin-v1.6.10-informational)](https://github.com/JetBrains/kotlin/releases/tag/v1.6.10)

## Overview:

Welcome to Passio Platform Android SDK!

When integrated into your app, the SDK provides you with recognition of your project. The SDK is designed to take a stream of images and output recognized classes in those images along with data configured in the Passio Platform.

By default the SDK does not record/store any photos or videos. Instead, as the end users hover over a recognizable item with their device, the SDK recognizes and identifies the item in real time. This hovering action is only transitory/temporary while the end user is pointing the camera at a particular item and is never recorded or stored within the SDK. As the developer, you can configure the SDK to capture images or videos and store them in the main app.

## Minimum Requirements And Dependencies

* Built with Kotlin version 1.6.10
* Minimum Android SDK version is 26
* The SDK requires access to the device's camera
* The SDK is built upon CameraX, TensorFlow and Firebase's ML Vision so these dependencies will need to be added to the project manually

## Download the Models and get the key from the platform.

1. Login into the platform https://platform.passiolife.com/ 
2. Under Project Status click on the "Continue" button on right of your project row. 
3. Under SDK Packaging select the latest Version and click on the "View Info"
4. Download the Android Package and unzip it. All of the files in the Android package are going to be needed to run the SDK. Make sure to put them in the `asset` folder in the app or download them on demand and push them to the sdk (more info can be found in the section *3. Initialize and configure the SDK*)

## Sandbox Project

A fast and easy way to get started with the SDK is to test it inside of PlatformSDKSandboxApp included in this package. Here are the steps:

1. Open the project in Android Studio
2. Copy the files from the Android Package downloaded from the Platform and paste them in the assets folder of the project.
3. In the onCreate() method of the MainActivity, replace the sdk key and the project ID within the PassioConfiguration object.

```kotlin
val config = PassioConfiguration(
    this.applicationContext,
    "Your SDK key"
)
PassioSDK.instance.configure(config) { status ->
```

5. Connect your Android device and run

## Adding Passio SDK into your project

### 1. Declare the dependency in your module
```
dependencies {
    ...
    implementation 'ai.passio.passiosdk:platformsdk:2.2.12'
    ...
}
```

### 2. Camera Permission and Preview

* The SDK requires the device's Camera to work. Acquire the user's permission to use the Camera with these steps: 
[Requesting Android permissions](https://developer.android.com/training/permissions/requesting).
* After the user grants the app the permission to use the Camera, proceed with configuring the Passio SDK.
* To enable the camera add a androidx.camera.view.PreviewView to you view hierarchy. This view will render the frames coming out of the camera manager that are meant for the preview.
* Implement the `CameraViewProvider` interface through an Activity, Fragment or a View which will server as a lifecycle owner for the camera.
* Calling the `startCamera` method starts the camera.

```kotlin
class MainActivity : AppCompatActivity(), PassioCameraViewProvider {
    ...
    override fun requestCameraLifecycleOwner(): LifecycleOwner {
        return this
    }

    override fun requestPreviewView(): PreviewView {
        return mainPreviewView
    }
    ...

    // This method is called after the permission to use the camera is granted
    private fun onCameraPermissionGranted() {
        PassioSDK.instance.startCamera(this)
    } 
}
```

### 3. Initialize and configure the SDK

* Use the API key generated by the Passio Platform.
* Be sure to protect the value of your SDK in the final app. There are several ways to do this, some of the [are listed here](https://stackoverflow.com/questions/14570989/best-practice-for-storing-and-protecting-private-api-keys-in-applications).  
* There are severals ways to configure the SDK depending on where the JSON metadata and models are:
    - In the assets folder
    - Downloaded by the app and provided to the SDK
    - Downloaded and managed by the app

* Instantiate a ```PassioConfiguraion``` object that will be used to start the SDK configure process

```kotlin
val config = PassioConfiguration(
    this.applicationContext,
    "Your SDK key"
)
```
* If the metadata file and model files are in the assets folder, just pass the configuration object to the ```PassioSDK.instance.configure``` method.
* If the metadata file and model files are downloaded by the app, but the SDK should have ownership of the files, add the file Uris to the ```localFiles``` attribute of the configuration object. Using this approach the SDK will copy over the files into it's folder structure (located in the cache of the app), and the files will be ready for usage the next time you initialize the SDK. Once the SDK configuration process has been completed successfully, the download files can be deleted from the download folder because the SDK will have copied them over. 
```kotlin
config.localFiles = getDownloadedFilesUris() 
```
* If the metadata file and model files are downloaded by the app, but the app is responsible for storing the files, use the ```pointToFiles``` attribute of the configuration object. This way, the SDK will just initialize the files from the source location, without copying over the files. The app is then responsible to keep the files in the source directory throughtout the duration of the session.
```kotlin
config.pointToFiles = getAppDownloadFolderUris() 
```
* Once the configuration object is defined, proceed with the SDK initialization process
```kotlin
PassioSDK.instance.configure(config) { status ->
    when (status.mode) {
        PassioMode.NOT_READY -> Toast.makeText(this, "SDK NOT READY", Toast.LENGTH_SHORT).show()
        PassioMode.FAILED_TO_CONFIGURE -> Toast.makeText(this, "SDK FAILED TO CONFIGURE", Toast.LENGTH_SHORT).show()
        PassioMode.IS_BEING_CONFIGURED -> Toast.makeText(this, "SDK BEING CONFIGURED", Toast.LENGTH_SHORT).show()
        PassioMode.IS_READY_FOR_DETECTION -> Toast.makeText(this, "SDK READY", Toast.LENGTH_SHORT).show()
    }
```

* The initialization process is being executed on a background thread, so it will not block the Main thread's execution. Once the initialization process is over, the SDK will automatically start analyzing frames if the camera has been started.
* When you call the configure method of the Passio SDK with the PassioConfiguration object, you will need to define a callback to handle the result of the configuration process. This result is comprised in the PassioStatus object.

```kotlin
class PassioStatus {
    var mode: PassioMode = PassioMode.NOT_READY
    var missingFiles: List<FileName>? = null
    var debugMessage: String? = null
    var activeModels: Int? = null
}
```

The **mode** of the PassioStatus defines what is the current status of the configuration process. There are 5 different modes, and they all should be handled by the implementing side.

```kotlin

enum class PassioMode {
    /**
     * Indicates that the configuration process has not started yet.
     */
    NOT_READY,

    /**
     * The configuration process has encountered an error and was not completed successfully.
     */
    FAILED_TO_CONFIGURE,

    /**
     * The configuration process is still running.
     */
    IS_BEING_CONFIGURED,

    /**
     * A newer version of files needed by the SDK are being downloaded.
     */
    IS_DOWNLOADING_MODELS,

    /**
     * All the files needed by the SDK are present and the SDK can be used to its full extent.
     */
    IS_READY_FOR_DETECTION
}
```

### 4. Start using the SDK

* To start the Detection process a `ClassificationListener` also has to be defined. The listener serves as a callback for recognition process of the incoming frames from the camera.


```kotlin
private val listener = object : ClassificationListener {
    override fun onClassificationResult(candidate: ClassificationCandidate, bitmap: Bitmap) {
        resultView.text = "${candidate.label.displayName}, ${String.format("%.02f", (candidate.confidence * 100))}%"
    }
}
```

* Using the listener start the detection by calling the `startFoodDetection` method of the SDK.

```kotlin
override fun onStart() {
    super.onStart()
    PassioSDK.instance.startDetection(listener)
}
```

* Stop the food recognition on the `onStop()` lifecycle callback.

```kotlin
override fun onStop() {
    PassioSDK.instance.stopDetection()
    super.onStop()
}
```

<sup>Copyright 2022 Passio Inc</sup>
